<h1>{{ isCurrentUserAdmin() ? 'Manage users' : 'Users' }}</h1>

@if (isCurrentUserAdmin()) {
<div class="text-right mb-5">
  <p-button
    (click)="addUser()"
    label="Add user"
    icon="pi pi-plus"
    severity="success"
  ></p-button>
</div>
}

<!-- TODO make table responsible (content inside rows shifted vertically on Mobile) -->
<p-table [value]="users()">
  <ng-template pTemplate="header">
    <tr>
      <th>Name</th>
      <th>Username</th>
      <th>Role</th>

      @if (isCurrentUserAdmin()) {
      <th></th>
      }
    </tr>
  </ng-template>

  <ng-template pTemplate="body" let-user>
    <tr>
      <td>{{ user.name }}</td>
      <td>{{ user.username }}</td>
      <td>{{ user.isAdmin ? 'Admin' : 'Regular' }}</td>

      @if (isCurrentUserAdmin()) {
      <td class="text-right w-3">
        <!-- TODO user should not be able to delete themselves -->
        <p-button
          label="Delete"
          icon="pi pi-trash"
          severity="danger"
          size="small"
          class="mr-2"
          (click)="confirmDeleteUser(user)"
        ></p-button>

        <p-button
          label="Edit"
          icon="pi pi-pencil"
          size="small"
          (click)="editUser(user)"
        >
        </p-button>
      </td>
      }
    </tr>
  </ng-template>
</p-table>

<p-dialog
  [header]="isEditMode() ? 'Edit user' : 'Add new user'"
  [visible]="displayEditDialog()"
  (visibleChange)="displayEditDialog.set($event)"
  [modal]="true"
  [closable]="false"
  [style]="{ 'width': '25rem', 'max-width': 'calc(100vw - 3rem)' }"
>
  <div class="p-fluid mb-3">
    <div class="p-field mb-3">
      <label for="name" class="block text-xs font-medium mb-1">Name</label>
      <input
        pInputText
        id="name"
        class="w-full"
        [ngModel]="selectedUser()?.name"
        (ngModelChange)="updateName($event)"
      />
    </div>
    <div class="p-field mb-3">
      <label for="username" class="block text-xs font-medium mb-1"
        >Username</label
      >
      <input
        pInputText
        id="username"
        class="w-full"
        [ngModel]="selectedUser()?.username"
        (ngModelChange)="updateUsername($event)"
      />
    </div>
    <div class="p-field mb-3">
      <label for="password" class="block text-xs font-medium mb-1">
        @if (isEditMode()) { New password } @else { Password }
      </label>
      <input
        pInputText
        type="password"
        id="password"
        class="w-full"
        [ngModel]="selectedUser()?.password"
        (ngModelChange)="updatePassword($event)"
        autocomplete="new-password"
      />
    </div>
    <div class="p-field mb-3">
      <label for="role" class="block text-xs font-medium mb-1">Role</label>
      <p-select
        id="role"
        class="w-full"
        [ngModel]="selectedUser()?.isAdmin"
        (ngModelChange)="updateRole($event)"
        [options]="roleOptions()"
        placeholder="Select a role"
        appendTo="body"
      >
      </p-select>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <p-button
      label="Cancel"
      severity="secondary"
      (click)="closeDialog()"
    ></p-button>
    <p-button [label]="isEditMode() ? 'Save' : 'Create'" (click)="saveUser()">
    </p-button>
  </ng-template>
</p-dialog>

<p-dialog
  header="Confirm deletion"
  [visible]="displayDeleteDialog()"
  (visibleChange)="displayDeleteDialog.set($event)"
  [modal]="true"
  [closable]="false"
>
  <div>
    Are you sure you want to delete user <b>{{ selectedUser()?.name }}</b>?
  </div>

  <ng-template pTemplate="footer">
    <p-button
      label="Cancel"
      severity="secondary"
      (click)="cancelDeleteUser()"
    ></p-button>
    <p-button
      label="Delete"
      severity="danger"
      (click)="deleteUserConfirmed()"
    ></p-button>
  </ng-template>
</p-dialog>
